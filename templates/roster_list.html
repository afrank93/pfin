{% extends "base.html" %}

{% block title %}{{ team.name }} Roster - Coach App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2">
                    <i class="bi bi-people me-2"></i>
                    {{ team.name }} Roster
                </h1>
                <p class="text-muted mb-0">{{ team.season }} Season</p>
            </div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                    <i class="bi bi-person-plus me-1"></i>Add Player
                </button>
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#importCsvModal">
                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>Import CSV
                </button>
                <a href="/api/teams/{{ team.id }}/players/export_csv" class="btn btn-info">
                    <i class="bi bi-download me-1"></i>Export CSV
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="filterPosition" class="form-label">Position</label>
                        <select class="form-select" id="filterPosition" name="position">
                            <option value="">All Positions</option>
                            <option value="F">Forward</option>
                            <option value="D">Defense</option>
                            <option value="G">Goalie</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterStatus" class="form-label">Status</label>
                        <select class="form-select" id="filterStatus" name="status">
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="Affiliate">Affiliate</option>
                            <option value="Injured">Injured</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterHand" class="form-label">Handedness</label>
                        <select class="form-select" id="filterHand" name="hand">
                            <option value="">All</option>
                            <option value="L">Left</option>
                            <option value="R">Right</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterBirthYear" class="form-label">Birth Year</label>
                        <input type="number" class="form-control" id="filterBirthYear" name="birth_year" 
                               placeholder="e.g., 2010" min="1990" max="2020">
                    </div>
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel me-1"></i>Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>Clear
                            </button>
                            <div class="ms-auto">
                                <label for="sortBy" class="form-label me-2">Sort by:</label>
                                <select class="form-select d-inline-block w-auto" id="sortBy" name="sort">
                                    <option value="name">Name</option>
                                    <option value="position">Position</option>
                                    <option value="jersey">Jersey</option>
                                    <option value="birthdate">Birth Date</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Players Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list me-2"></i>
                    Players (<span id="player-count">{{ players|length }}</span>)
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="viewMode" id="tableView" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="tableView">
                        <i class="bi bi-table"></i>
                    </label>
                    <input type="radio" class="btn-check" name="viewMode" id="cardView" autocomplete="off">
                    <label class="btn btn-outline-primary" for="cardView">
                        <i class="bi bi-grid"></i>
                    </label>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Table View -->
                <div id="tableView" class="view-mode">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Jersey</th>
                                    <th>Name</th>
                                    <th>Position</th>
                                    <th>Hand</th>
                                    <th>Birth Date</th>
                                    <th>Age</th>
                                    <th>Status</th>
                                    <th>Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="playersTableBody">
                                {% for player in players %}
                                <tr data-player-id="{{ player.id }}">
                                    <td>
                                        {% if player.jersey %}
                                            <span class="badge bg-primary">{{ player.jersey }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ player.name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge position-{{ player.position.lower() }}">
                                            {{ player.position }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if player.hand %}
                                            <i class="bi bi-{{ 'arrow-left' if player.hand == 'L' else 'arrow-right' }} hand-{{ player.hand.lower() }}"></i>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if player.birthdate %}
                                            {{ player.birthdate.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if player.birthdate %}
                                            {{ ((now - player.birthdate).days // 365) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge status-{{ player.status.lower() }}">
                                            {{ player.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column small">
                                            {% if player.email %}
                                                <a href="mailto:{{ player.email }}" class="text-decoration-none">
                                                    <i class="bi bi-envelope me-1"></i>{{ player.email }}
                                                </a>
                                            {% endif %}
                                            {% if player.phone %}
                                                <a href="tel:{{ player.phone }}" class="text-decoration-none">
                                                    <i class="bi bi-telephone me-1"></i>{{ player.phone }}
                                                </a>
                                            {% endif %}
                                            {% if not player.email and not player.phone %}
                                                <span class="text-muted">No contact info</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary" 
                                                    onclick="editPlayer({{ player.id }})" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" 
                                                    onclick="deletePlayer({{ player.id }})" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Card View -->
                <div id="cardView" class="view-mode d-none">
                    <div class="row p-3" id="playersCardContainer">
                        {% for player in players %}
                        <div class="col-md-6 col-lg-4 mb-3" data-player-id="{{ player.id }}">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">{{ player.name }}</h6>
                                        {% if player.jersey %}
                                            <span class="badge bg-primary">{{ player.jersey }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge position-{{ player.position.lower() }} me-1">
                                            {{ player.position }}
                                        </span>
                                        <span class="badge status-{{ player.status.lower() }}">
                                            {{ player.status }}
                                        </span>
                                    </div>
                                    <div class="small text-muted mb-2">
                                        {% if player.birthdate %}
                                            <i class="bi bi-calendar me-1"></i>
                                            {{ player.birthdate.strftime('%Y-%m-%d') }}
                                            ({{ ((now - player.birthdate).days // 365) }} years old)
                                        {% endif %}
                                        {% if player.hand %}
                                            <br><i class="bi bi-{{ 'arrow-left' if player.hand == 'L' else 'arrow-right' }} me-1"></i>
                                            {{ 'Left' if player.hand == 'L' else 'Right' }} handed
                                        {% endif %}
                                    </div>
                                    {% if player.email or player.phone %}
                                        <div class="small">
                                            {% if player.email %}
                                                <a href="mailto:{{ player.email }}" class="text-decoration-none d-block">
                                                    <i class="bi bi-envelope me-1"></i>{{ player.email }}
                                                </a>
                                            {% endif %}
                                            {% if player.phone %}
                                                <a href="tel:{{ player.phone }}" class="text-decoration-none d-block">
                                                    <i class="bi bi-telephone me-1"></i>{{ player.phone }}
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="editPlayer({{ player.id }})">
                                            <i class="bi bi-pencil me-1"></i>Edit
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                onclick="deletePlayer({{ player.id }})">
                                            <i class="bi bi-trash me-1"></i>Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Empty State -->
                {% if not players %}
                <div class="text-center py-5">
                    <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">No players found</h5>
                    <p class="text-muted">Add your first player to get started.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                        <i class="bi bi-person-plus me-1"></i>Add Player
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Player Modal -->
<div class="modal fade" id="addPlayerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPlayerForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="playerName" class="form-label">Player Name *</label>
                                <input type="text" class="form-control" id="playerName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="playerPosition" class="form-label">Position *</label>
                                <select class="form-select" id="playerPosition" name="position" required>
                                    <option value="">Select position...</option>
                                    <option value="F">Forward</option>
                                    <option value="D">Defense</option>
                                    <option value="G">Goalie</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="playerJersey" class="form-label">Jersey Number</label>
                                <input type="number" class="form-control" id="playerJersey" name="jersey" min="1" max="99">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="playerHand" class="form-label">Handedness</label>
                                <select class="form-select" id="playerHand" name="hand">
                                    <option value="">Select...</option>
                                    <option value="L">Left</option>
                                    <option value="R">Right</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="playerBirthdate" class="form-label">Birth Date</label>
                                <input type="date" class="form-control" id="playerBirthdate" name="birthdate">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="playerStatus" class="form-label">Status</label>
                                <select class="form-select" id="playerStatus" name="status">
                                    <option value="Active">Active</option>
                                    <option value="Affiliate">Affiliate</option>
                                    <option value="Injured">Injured</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="playerEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="playerEmail" name="email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="playerPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="playerPhone" name="phone">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Player Modal -->
<div class="modal fade" id="editPlayerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editPlayerForm">
                <input type="hidden" id="editPlayerId" name="id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPlayerName" class="form-label">Player Name *</label>
                                <input type="text" class="form-control" id="editPlayerName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editPlayerPosition" class="form-label">Position *</label>
                                <select class="form-select" id="editPlayerPosition" name="position" required>
                                    <option value="">Select position...</option>
                                    <option value="F">Forward</option>
                                    <option value="D">Defense</option>
                                    <option value="G">Goalie</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editPlayerJersey" class="form-label">Jersey Number</label>
                                <input type="number" class="form-control" id="editPlayerJersey" name="jersey" min="1" max="99">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editPlayerHand" class="form-label">Handedness</label>
                                <select class="form-select" id="editPlayerHand" name="hand">
                                    <option value="">Select...</option>
                                    <option value="L">Left</option>
                                    <option value="R">Right</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editPlayerBirthdate" class="form-label">Birth Date</label>
                                <input type="date" class="form-control" id="editPlayerBirthdate" name="birthdate">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editPlayerStatus" class="form-label">Status</label>
                                <select class="form-select" id="editPlayerStatus" name="status">
                                    <option value="Active">Active</option>
                                    <option value="Affiliate">Affiliate</option>
                                    <option value="Injured">Injured</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPlayerEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editPlayerEmail" name="email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPlayerPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="editPlayerPhone" name="phone">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importCsvModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Players from CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="importCsvForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                        <div class="form-text">
                            Expected columns: name, position, jersey, hand, birthdate, email, phone, status
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Duplicate players will be flagged but not prevented from import.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Import CSV</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    setupViewModeToggle();
    setupFormHandlers();
    setupFilters();
});

function setupViewModeToggle() {
    const tableView = document.getElementById('tableView');
    const cardView = document.getElementById('cardView');
    const tableRadio = document.getElementById('tableView');
    const cardRadio = document.getElementById('cardView');
    
    tableRadio.addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('tableView').classList.remove('d-none');
            document.getElementById('cardView').classList.add('d-none');
        }
    });
    
    cardRadio.addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('tableView').classList.add('d-none');
            document.getElementById('cardView').classList.remove('d-none');
        }
    });
}

function setupFormHandlers() {
    // Add player form
    document.getElementById('addPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        fetch('/api/teams/{{ team.id }}/players', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            CoachApp.showToast('Player added successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addPlayerModal')).hide();
            this.reset();
            location.reload();
        })
        .catch(error => {
            CoachApp.showToast('Error adding player: ' + error.message, 'error');
        });
    });
    
    // Edit player form
    document.getElementById('editPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        const playerId = data.id;
        
        fetch(`/api/players/${playerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            CoachApp.showToast('Player updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editPlayerModal')).hide();
            location.reload();
        })
        .catch(error => {
            CoachApp.showToast('Error updating player: ' + error.message, 'error');
        });
    });
    
    // Import CSV form
    document.getElementById('importCsvForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/api/teams/{{ team.id }}/players/import_csv', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            CoachApp.showToast(`CSV imported: ${data.imported} players added`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('importCsvModal')).hide();
            this.reset();
            location.reload();
        })
        .catch(error => {
            CoachApp.showToast('Error importing CSV: ' + error.message, 'error');
        });
    });
}

function setupFilters() {
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = new URLSearchParams();
        
        for (const [key, value] of formData.entries()) {
            if (value) params.append(key, value);
        }
        
        const url = new URL(window.location);
        url.search = params.toString();
        window.location.href = url.toString();
    });
}

function clearFilters() {
    document.getElementById('filterForm').reset();
    const url = new URL(window.location);
    url.search = '';
    window.location.href = url.toString();
}

function editPlayer(playerId) {
    // Fetch player data and populate edit form
    fetch(`/api/players/${playerId}`)
        .then(response => response.json())
        .then(player => {
            document.getElementById('editPlayerId').value = player.id;
            document.getElementById('editPlayerName').value = player.name;
            document.getElementById('editPlayerPosition').value = player.position;
            document.getElementById('editPlayerJersey').value = player.jersey || '';
            document.getElementById('editPlayerHand').value = player.hand || '';
            document.getElementById('editPlayerBirthdate').value = player.birthdate ? 
                CoachApp.formatDateForInput(player.birthdate) : '';
            document.getElementById('editPlayerStatus').value = player.status;
            document.getElementById('editPlayerEmail').value = player.email || '';
            document.getElementById('editPlayerPhone').value = player.phone || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editPlayerModal'));
            modal.show();
        })
        .catch(error => {
            CoachApp.showToast('Error loading player data: ' + error.message, 'error');
        });
}

function deletePlayer(playerId) {
    CoachApp.confirm('Are you sure you want to delete this player? This action cannot be undone.', function() {
        fetch(`/api/players/${playerId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                CoachApp.showToast('Player deleted successfully!', 'success');
                location.reload();
            } else {
                throw new Error('Failed to delete player');
            }
        })
        .catch(error => {
            CoachApp.showToast('Error deleting player: ' + error.message, 'error');
        });
    });
}
</script>
{% endblock %}
