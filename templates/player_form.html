<!-- Player Form Modal -->
<div class="modal fade" id="playerFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="playerFormTitle">Add New Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="playerForm">
                <input type="hidden" id="playerId" name="id">
                <div class="modal-body">
                    <!-- Validation Errors -->
                    <div id="formErrors" class="alert alert-danger d-none" role="alert">
                        <h6 class="alert-heading">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Please fix the following errors:
                        </h6>
                        <ul id="errorList" class="mb-0"></ul>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="playerName" class="form-label">Player Name *</label>
                                <input type="text" class="form-control" id="playerName" name="name" required>
                                <div class="invalid-feedback" id="nameError"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="playerPosition" class="form-label">Position *</label>
                                <select class="form-select" id="playerPosition" name="position" required>
                                    <option value="">Select position...</option>
                                    <option value="F">Forward</option>
                                    <option value="D">Defense</option>
                                    <option value="G">Goalie</option>
                                </select>
                                <div class="invalid-feedback" id="positionError"></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="playerJersey" class="form-label">Jersey Number</label>
                                <input type="number" class="form-control" id="playerJersey" name="jersey" min="1" max="99">
                                <div class="invalid-feedback" id="jerseyError"></div>
                                <div class="form-text">Optional, 1-99</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="playerHand" class="form-label">Handedness</label>
                                <select class="form-select" id="playerHand" name="hand">
                                    <option value="">Select...</option>
                                    <option value="L">Left</option>
                                    <option value="R">Right</option>
                                </select>
                                <div class="invalid-feedback" id="handError"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="playerBirthdate" class="form-label">Birth Date</label>
                                <input type="date" class="form-control" id="playerBirthdate" name="birthdate">
                                <div class="invalid-feedback" id="birthdateError"></div>
                                <div class="form-text">YYYY-MM-DD format</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="playerStatus" class="form-label">Status</label>
                                <select class="form-select" id="playerStatus" name="status">
                                    <option value="Active">Active</option>
                                    <option value="Affiliate">Affiliate</option>
                                    <option value="Injured">Injured</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                                <div class="invalid-feedback" id="statusError"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="playerEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="playerEmail" name="email">
                                <div class="invalid-feedback" id="emailError"></div>
                                <div class="form-text">Optional contact email</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="playerPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="playerPhone" name="phone">
                                <div class="invalid-feedback" id="phoneError"></div>
                                <div class="form-text">Optional contact phone</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitButton">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        <span id="submitText">Add Player</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Player Form JavaScript
class PlayerForm {
    constructor() {
        this.modal = null;
        this.form = document.getElementById('playerForm');
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Form submission
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        
        // Real-time validation
        const inputs = this.form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('blur', () => this.validateField(input));
            input.addEventListener('input', () => this.clearFieldError(input));
        });
    }

    show(teamId, playerId = null) {
        this.teamId = teamId;
        this.playerId = playerId;
        
        // Reset form
        this.resetForm();
        
        // Set title and submit button text
        const title = document.getElementById('playerFormTitle');
        const submitText = document.getElementById('submitText');
        
        if (playerId) {
            title.textContent = 'Edit Player';
            submitText.textContent = 'Update Player';
            this.loadPlayerData(playerId);
        } else {
            title.textContent = 'Add New Player';
            submitText.textContent = 'Add Player';
        }
        
        // Show modal
        this.modal = new bootstrap.Modal(document.getElementById('playerFormModal'));
        this.modal.show();
    }

    resetForm() {
        this.form.reset();
        this.clearAllErrors();
        document.getElementById('playerId').value = '';
    }

    async loadPlayerData(playerId) {
        try {
            const response = await fetch(`/api/players/${playerId}`);
            const player = await response.json();
            
            // Populate form fields
            document.getElementById('playerId').value = player.id;
            document.getElementById('playerName').value = player.name;
            document.getElementById('playerPosition').value = player.position;
            document.getElementById('playerJersey').value = player.jersey || '';
            document.getElementById('playerHand').value = player.hand || '';
            document.getElementById('playerBirthdate').value = player.birthdate ? 
                CoachApp.formatDateForInput(player.birthdate) : '';
            document.getElementById('playerStatus').value = player.status;
            document.getElementById('playerEmail').value = player.email || '';
            document.getElementById('playerPhone').value = player.phone || '';
        } catch (error) {
            CoachApp.showToast('Error loading player data: ' + error.message, 'error');
        }
    }

    async handleSubmit(e) {
        e.preventDefault();
        
        if (!this.validateForm()) {
            return;
        }
        
        this.setLoading(true);
        
        try {
            const formData = new FormData(this.form);
            const data = Object.fromEntries(formData);
            
            const url = this.playerId ? 
                `/api/players/${this.playerId}` : 
                `/api/teams/${this.teamId}/players`;
            const method = this.playerId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                this.handleValidationErrors(errorData);
                return;
            }
            
            const result = await response.json();
            const message = this.playerId ? 
                'Player updated successfully!' : 
                'Player added successfully!';
            
            CoachApp.showToast(message, 'success');
            this.modal.hide();
            
            // Trigger page refresh or update
            if (typeof window.refreshPlayerList === 'function') {
                window.refreshPlayerList();
            } else {
                location.reload();
            }
            
        } catch (error) {
            CoachApp.showToast('Error saving player: ' + error.message, 'error');
        } finally {
            this.setLoading(false);
        }
    }

    validateForm() {
        let isValid = true;
        const requiredFields = ['name', 'position'];
        
        requiredFields.forEach(fieldName => {
            const field = this.form.querySelector(`[name="${fieldName}"]`);
            if (!this.validateField(field)) {
                isValid = false;
            }
        });
        
        // Validate optional fields if they have values
        const emailField = this.form.querySelector('[name="email"]');
        const phoneField = this.form.querySelector('[name="phone"]');
        
        if (emailField.value && !CoachApp.isValidEmail(emailField.value)) {
            this.setFieldError(emailField, 'Please enter a valid email address');
            isValid = false;
        }
        
        if (phoneField.value && !CoachApp.isValidPhone(phoneField.value)) {
            this.setFieldError(phoneField, 'Please enter a valid phone number');
            isValid = false;
        }
        
        return isValid;
    }

    validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        
        // Clear previous errors
        this.clearFieldError(field);
        
        // Required field validation
        if (field.hasAttribute('required') && !value) {
            this.setFieldError(field, `${this.getFieldLabel(fieldName)} is required`);
            return false;
        }
        
        // Specific field validations
        switch (fieldName) {
            case 'jersey':
                if (value && (isNaN(value) || value < 1 || value > 99)) {
                    this.setFieldError(field, 'Jersey number must be between 1 and 99');
                    return false;
                }
                break;
            case 'email':
                if (value && !CoachApp.isValidEmail(value)) {
                    this.setFieldError(field, 'Please enter a valid email address');
                    return false;
                }
                break;
            case 'phone':
                if (value && !CoachApp.isValidPhone(value)) {
                    this.setFieldError(field, 'Please enter a valid phone number');
                    return false;
                }
                break;
        }
        
        return true;
    }

    setFieldError(field, message) {
        field.classList.add('is-invalid');
        const errorElement = document.getElementById(`${field.name}Error`);
        if (errorElement) {
            errorElement.textContent = message;
        }
    }

    clearFieldError(field) {
        field.classList.remove('is-invalid');
        const errorElement = document.getElementById(`${field.name}Error`);
        if (errorElement) {
            errorElement.textContent = '';
        }
    }

    clearAllErrors() {
        const errorFields = this.form.querySelectorAll('.is-invalid');
        errorFields.forEach(field => this.clearFieldError(field));
        
        const errorAlert = document.getElementById('formErrors');
        errorAlert.classList.add('d-none');
    }

    handleValidationErrors(errorData) {
        this.clearAllErrors();
        
        if (errorData.detail && Array.isArray(errorData.detail)) {
            // Handle Pydantic validation errors
            const errorList = document.getElementById('errorList');
            errorList.innerHTML = '';
            
            errorData.detail.forEach(error => {
                const fieldName = error.loc ? error.loc[error.loc.length - 1] : 'form';
                const field = this.form.querySelector(`[name="${fieldName}"]`);
                
                if (field) {
                    this.setFieldError(field, error.msg);
                } else {
                    // Add to general error list
                    const li = document.createElement('li');
                    li.textContent = error.msg;
                    errorList.appendChild(li);
                }
            });
            
            if (errorList.children.length > 0) {
                document.getElementById('formErrors').classList.remove('d-none');
            }
        } else if (errorData.message) {
            CoachApp.showToast(errorData.message, 'error');
        }
    }

    setLoading(loading) {
        const submitButton = document.getElementById('submitButton');
        const spinner = submitButton.querySelector('.spinner-border');
        
        if (loading) {
            submitButton.disabled = true;
            spinner.classList.remove('d-none');
        } else {
            submitButton.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    getFieldLabel(fieldName) {
        const labels = {
            'name': 'Player Name',
            'position': 'Position',
            'jersey': 'Jersey Number',
            'hand': 'Handedness',
            'birthdate': 'Birth Date',
            'status': 'Status',
            'email': 'Email',
            'phone': 'Phone'
        };
        return labels[fieldName] || fieldName;
    }
}

// Initialize player form when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.playerForm = new PlayerForm();
});

// Global functions for backward compatibility
function showAddPlayerForm(teamId) {
    window.playerForm.show(teamId);
}

function showEditPlayerForm(teamId, playerId) {
    window.playerForm.show(teamId, playerId);
}
</script>
